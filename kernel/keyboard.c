#include "keyboard.h"
#include "print.h"
#include "lib.h"

array_queue keyboard_buf = INIT_ARRAY_QUEUE(128);
unsigned char scancode_map[NR_SCANCODE] = {
/* 0000 */ 0x00,
/* 0x01 */ 0x00,
/* 0x02 */ '1',
/* 0x03 */ '2',
/* 0x04 */ '3',
/* 0x05 */ '4',
/* 0x06 */ '5',
/* 0x07 */ '6',
/* 0x08 */ '7',
/* 0x09 */ '8',
/* 0x0a */ '9',
/* 0x0b */ '0',
/* 0x0c */ '-',
/* 0x0d */ '=',
/* 0x0e */ 0x00,
/* 0x0f */ 0x00,
/* 0x10 */ 'Q',
/* 0x11 */ 'W',
/* 0x12 */ 'E',
/* 0x13 */ 'R',
/* 0x14 */ 'T',
/* 0x15 */ 'Y',
/* 0x16 */ 'U',
/* 0x17 */ 'I',
/* 0x18 */ 'O',
/* 0x19 */ 'P',
/* 0x1a */ '[',
/* 0x1b */ ']',
/* 0x1c */ 0x00,
/* 0x1d */ 0x00,
/* 0x1e */ 'A',
/* 0x1f */ 'S',
/* 0x20 */ 'D',
/* 0x21 */ 'F',
/* 0x22 */ 'G',
/* 0x23 */ 'H',
/* 0x24 */ 'J',
/* 0x25 */ 'K',
/* 0x26 */ 'L',
/* 0x27 */ ';',
/* 0x28 */ '\'',
/* 0x29 */ '`',
/* 0x2a */ 0x00,
/* 0x2b */ '\\',
/* 0x2c */ 'Z',
/* 0x2d */ 'X',
/* 0x2e */ 'C',
/* 0x2f */ 'V',
/* 0x30 */ 'B',
/* 0x31 */ 'N',
/* 0x32 */ 'M',
/* 0x33 */ ',',
/* 0x34 */ '.',
/* 0x35 */ '/',
/* 0x36 */ 0x00,
/* 0x37 */ 0x00,
/* 0x38 */ 0x00,
/* 0x39 */ 0x00,
/* 0x3a */ 0x00,
/* 0x3b */ 0x00,
/* 0x3c */ 0x00,
/* 0x3d */ 0x00,
/* 0x3e */ 0x00,
/* 0x3f */ 0x00,
/* 0x40 */ 0x00,
/* 0x41 */ 0x00,
/* 0x42 */ 0x00,
/* 0x43 */ 0x00,
/* 0x44 */ 0x00,
/* 0x45 */ 0x00,
/* 0x46 */ 0x00,
/* 0x47 */ 0x00,
/* 0x48 */ 0x00,
/* 0x49 */ 0x00,
/* 0x4a */ 0x00,
/* 0x4b */ 0x00,
/* 0x4c */ 0x00,
/* 0x4d */ 0x00,
/* 0x4e */ 0x00,
/* 0x4f */ 0x00,
/* 0x50 */ 0x00,
/* 0x51 */ 0x00,
/* 0x52 */ 0x00,
/* 0x53 */ 0x00,
/* 0x54 */ 0x00,
/* 0x55 */ 0x00,
/* 0x56 */ 0x00,
/* 0x57 */ 0x00,
/* 0x58 */ 0x00,
/* 0x59 */ 0x00,
/* 0x5a */ 0x00,
/* 0x5b */ 0x00,
/* 0x5c */ 0x00,
/* 0x5d */ 0x00,
/* 0x5e */ 0x00,
/* 0x5f */ 0x00,
/* 0x60 */ 0x00,
/* 0x61 */ 0x00,
/* 0x62 */ 0x00,
/* 0x63 */ 0x00,
/* 0x64 */ 0x00,
/* 0x65 */ 0x00,
/* 0x66 */ 0x00,
/* 0x67 */ 0x00,
/* 0x68 */ 0x00,
/* 0x69 */ 0x00,
/* 0x6a */ 0x00,
/* 0x6b */ 0x00,
/* 0x6c */ 0x00,
/* 0x6d */ 0x00,
/* 0x6e */ 0x00,
/* 0x6f */ 0x00,
/* 0x70 */ 0x00,
/* 0x71 */ 0x00,
/* 0x72 */ 0x00,
/* 0x73 */ 0x00,
/* 0x74 */ 0x00,
/* 0x75 */ 0x00,
/* 0x76 */ 0x00,
/* 0x77 */ 0x00,
/* 0x78 */ 0x00,
/* 0x79 */ 0x00,
/* 0x7a */ 0x00,
/* 0x7b */ 0x00,
/* 0x7c */ 0x00,
/* 0x7d */ 0x00,
/* 0x7e */ 0x00,
/* 0x7f */ 0x00,
};

void init_keybord(){
}

void keyboard_handle(unsigned long nr){
    char key = io_in8(KB_DATA_PORT);
    queue_put(&keyboard_buf, key);
    io_out8(0x20, 0x20);
}

void analysis_keycode(){
    unsigned char key = queue_get(&keyboard_buf);
    if(key == 0x00)return;
    if(key == PRIFIX_CODE){
        unsigned char code = queue_get(&keyboard_buf);
        switch (code & BREAK_MASIK) {
            case 0x5b:info("INPUT L GUI\n");
                      break;
            case 0x1d:info("INPUT R CTRL\n");
                      break;
            case 0x5c:info("INPUT R GUI");
                      break;
            case 0x38:info("INPUT R ALT\n");
                      break;
            case 0x5d:info("INPUT APPS\n");
                      break;
            case 0x2a:info("INPUT PRNT\n");
                      break;
            case 0x37:info("INPUT SCRN\n");
        }
        return;
    }
    if(key & BREAK_FLAG){//BREAK CODE
        info("REPLASE KEY %c\n",scancode_map[key & BREAK_MASIK]);
    }else{//MAKE CODE
        info("PRESS KEY %c\n",scancode_map[key & BREAK_MASIK]);
    }
}
